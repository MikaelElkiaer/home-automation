<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Extrude polygons for 3D indoor mapping</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<link href="https://api.mapbox.com/mapbox-gl-js/v3.10.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v3.10.0/mapbox-gl.js"></script>
<style>
body { margin: 0; padding: 0; }
#map { position: absolute; top: 0; bottom: 0; width: 100%; }
</style>
</head>
<body>
<div id="map"></div>
<script>
  mapboxgl.accessToken = 'pk.eyJ1IjoibWlrYWVsZWxraWFlciIsImEiOiJjbThmcDB2ancwaDVtMmtzNW90aHhpajB0In0.ci-D2cmgCk_o_X__9jhBFg';
  const map = new mapboxgl.Map({
      container: 'map',
      // Choose from Mapbox's core styles, or make your own style with Mapbox Studio
      style: 'mapbox://styles/mapbox/dark-v11',
      center: [ 9.93809816131456, 57.00256595817176 ],
      zoom: 20,
      pitch: 40,
      bearing: 20,
      antialias: true
  });

  map.on('load', async () => {
      const response = await fetch('/data.geojson');
      const data = await response.json();
      let lastModified = response.headers.get('Last-Modified');
      map.addSource('floorplan', {
          'type': 'geojson',
          'data': data
      });
      const timer = setInterval(async () => {
          const response = await fetch('/data.geojson');
          const data = await response.json();
          const newLastModified = response.headers.get('Last-Modified');
          if (newLastModified === lastModified) {
              console.log('No new data');
              return;
          }
          console.log('Updating data');
          lastModified = newLastModified;
          map.getSource('floorplan').setData(data);
      }, 1000);
      map.addLayer({
          'id': 'room-extrusion',
          'type': 'fill-extrusion',
          'source': 'floorplan',
          'paint': {
              // Get the `fill-extrusion-color` from the source `color` property.
              'fill-extrusion-color': ['get', 'color'],

              // Get `fill-extrusion-height` from the source `height` property.
              'fill-extrusion-height': ['get', 'height'],

              // Get `fill-extrusion-base` from the source `base_height` property.
              'fill-extrusion-base': ['get', 'base_height'],

              // Make extrusions slightly opaque to see through indoor walls.
              'fill-extrusion-opacity': 0.5
          }
      });
    });
</script>

</body>
</html>
